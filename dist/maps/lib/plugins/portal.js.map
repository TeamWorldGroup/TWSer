{"version":3,"sources":["lib/plugins/portal.js"],"names":["require","portal_detector","detectFrame","generatePortal","addPortalToWorld","Vec3","UserError","module","exports","player","serv","use_flint_and_steel","referencePosition","direction","position","world","getBlock","block","name","frames","length","air","forEach","setBlock","pos","bottom","x","portals","push","changeBlock","on","destroyPortal","portal","positionAlreadyDone","splice","indexOf","filter","ap","equals","p","top","left","right","concat","apply","reduce","acc","commands","add","base","info","usage","op","parse","str","pars","split","y","z","width","height","map","val","i","posFromString","bottomLeft","action","type"],"mappings":"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","file":"../../../lib/plugins/portal.js","sourcesContent":["const {detectFrame,generatePortal,addPortalToWorld}=require(\"flying-squid\").portal_detector;\nconst Vec3 = require(\"vec3\").Vec3;\nconst UserError=require(\"flying-squid\").UserError;\n\nmodule.exports.player=function(player,serv) {\n  player.use_flint_and_steel=async (referencePosition,direction,position) => {\n    let block=await player.world.getBlock(referencePosition);\n    if(block.name==\"obsidian\")\n    {\n      const frames=await detectFrame(player.world,referencePosition,direction);\n      if(frames.length!=0) {\n        const air = frames[0].air;\n        air.forEach(pos => player.setBlock(pos, 90, (frames[0].bottom[0].x - frames[0].bottom[1].x) != 0 ? 1 : 2));\n        player.world.portals.push(frames[0]);\n        return;\n      }\n    }\n    player.changeBlock(position, 51, 0);\n  };\n\n  player.on(\"dug\",({position,block}) => {\n\n    function destroyPortal(portal,positionAlreadyDone=null)\n    {\n      player.world.portals=player.world.portals.splice(player.world.portals.indexOf(portal),1);\n      portal\n        .air\n        .filter(ap => positionAlreadyDone==null || !ap.equals(positionAlreadyDone))\n        .forEach(ap => serv.setBlock(player.world,ap,0,0));\n    }\n\n    if(block.name==\"obsidian\")\n    {\n      const p=player.world.portals.filter(({bottom,top,left,right}) =>\n        [].concat.apply([], [bottom, left, right,top])\n          .reduce((acc,pos) => acc || pos.equals(position),false));\n      p.forEach(portal => destroyPortal(portal,position));\n    }\n\n    if(block.name==\"portal\")\n    {\n      const p=player.world.portals.filter(({air}) => air.reduce((acc,pos) => acc || pos.equals(position),false));\n      p.forEach(portal => destroyPortal(portal,position));\n    }\n  });\n\n\n\n  player.commands.add({\n    base: 'portal',\n    info: 'Create a portal frame',\n    usage: '/portal <bottomLeft:<x> <y> <z>> <direction:x|z> <width> <height>',\n    op: true,\n    parse(str) {\n      const pars=str.split(' ');\n      if(pars.length!=6)\n        return false;\n      let [x,y,z,direction,width,height]=pars;\n      [x,y,z] = [x,y,z].map((val, i) => serv.posFromString(val, player.position[['x','y','z'][i]] / 32));\n      const bottomLeft=new Vec3(x,y,z);\n      if(direction!=\"x\" && direction!=\"z\")\n        throw new UserError('Wrong Direction');\n      direction=direction=='x' ? new Vec3(1,0,0) : new Vec3(0,0,1);\n      return {bottomLeft,direction,width,height};\n    },\n    async action({bottomLeft,direction,width,height}) {\n      if(width>21 || height>21)\n        throw new UserError(\"Portals can only be 21x21!\");\n      const portal=generatePortal(bottomLeft,direction,width,height);\n      await addPortalToWorld(player.world,portal,[],[],async (pos,type) => {\n        await serv.setBlock(player.world,pos,type,0);\n      });\n    }\n  });\n\n};"]}