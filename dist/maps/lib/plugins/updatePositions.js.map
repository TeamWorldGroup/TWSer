{"version":3,"sources":["lib/plugins/updatePositions.js"],"names":["Vec3","require","prototype","toFixedPosition","scaled","floored","module","exports","player","_client","on","yaw","pitch","onGround","sendLook","conv","f","b","Math","floor","behavior","convYaw","convPitch","_writeOthersNearby","entityId","id","headYaw","sendSelfPosition","x","y","z","sendPosition","write","position","flags","teleport","notCancelled","sendAbilities","godmode","gameMode","canFly","isFlying","creativeMode","walkingSpeed","effects","amplifier","flyingSpeed","entity","Error","equals","resolve","diff","minus","abs","distanceTo","dX","dY","dZ","type","pos"],"mappings":"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","file":"../../../lib/plugins/updatePositions.js","sourcesContent":["const Vec3 = require(\"vec3\").Vec3;\n\nVec3.prototype.toFixedPosition=function() {\n  return this.scaled(32).floored();\n};\n\nmodule.exports.player=function(player)\n{\n  player._client.on('look', ({yaw,pitch,onGround} = {}) => sendLook(yaw,pitch,onGround));\n\n  // float (degrees) --> byte (1/256 \"degrees\")\n  function conv(f){\n    let b = Math.floor((f % 360) * 256 / 360);\n    if (b < -128) b += 256;\n    else if (b > 127) b -= 256;\n    return b;\n  }\n  function sendLook(yaw,pitch,onGround)\n  {\n    player.behavior('look', {\n      yaw: yaw,\n      pitch: pitch,\n      onGround: onGround\n    }, () => {\n      const convYaw=conv(yaw);\n      const convPitch=conv(pitch);\n      if (convYaw == player.yaw && convPitch == player.pitch) return;\n      player._writeOthersNearby(\"entity_look\", {\n        entityId: player.id,\n        yaw: convYaw,\n        pitch: convPitch,\n        onGround: onGround\n      });\n      player.yaw = convYaw;\n      player.pitch = convPitch;\n      player.onGround = onGround;\n      player._writeOthersNearby(\"entity_head_rotation\", {\n        entityId: player.id,\n        headYaw: convYaw\n      });\n    }, () => {\n      player.sendSelfPosition();\n    });\n  }\n\n  player._client.on('position', ({x,y,z,onGround} = {}) => {\n    player.sendPosition((new Vec3(x, y, z)).toFixedPosition(), onGround);\n  });\n\n  player._client.on('position_look', ({x,y,z,onGround,yaw,pitch} = {}) => {\n    player.sendPosition((new Vec3(x, y, z)).toFixedPosition(), onGround);\n    sendLook(yaw,pitch,onGround);\n  });\n\n  player.sendSelfPosition = () => {\n    player._client.write('position', {\n      x: player.position.x/32,\n      y: player.position.y/32,\n      z: player.position.z/32,\n      yaw: player.yaw,\n      pitch: player.pitch,\n      flags: 0x00\n    });\n  };\n\n  player.teleport = async (position) => {\n    const notCancelled = await player.sendPosition(position.scaled(32).floored(), false, true);\n    if (notCancelled) player.sendSelfPosition();\n  };\n\n  player.sendAbilities = () => { // TODO: Fix all of this...\n    const godmode = player.gameMode == 1 || player.gameMode == 3;\n    const canFly = player.gameMode == 1 || player.gameMode == 3;\n    const isFlying = !player.onGround && canFly;\n    const creativeMode = player.gameMode == 1;\n    const f = (+godmode*8) + (+canFly*4) + (+isFlying*2) + (+creativeMode);\n    const walkingSpeed = 0.2 * (1 + (player.effects[1] != null ? (player.effects[1].amplifier + 1) : 0) * 0.2);\n    const flyingSpeed = 0.1;\n    /*console.log(walkingSpeed, flyingSpeed);\n    player._client.write('abilities', { // FIIIIXXXXXXX\n      flags: f,\n      walkingSpeed: walkingSpeed,\n      flyingSpeed: flyingSpeed\n    });*/ \n  }\n};\n\nmodule.exports.entity=function(entity){\n  entity.sendPosition = (position, onGround, teleport=false) => {\n    if (typeof position == 'undefined') throw new Error('undef');\n    if (entity.position.equals(position) && entity.onGround == onGround) return Promise.resolve();\n    return entity.behavior('move', {\n      position: position,\n      onGround: onGround,\n      teleport: teleport\n    }, ({position,onGround}) => {\n      const diff = position.minus(entity.position);\n      if(diff.abs().x>127 || diff.abs().y>127 || diff.abs().z>127)\n        entity._writeOthersNearby('entity_teleport', {\n          entityId: entity.id,\n          x: position.x,\n          y: position.y,\n          z: position.z,\n          yaw: entity.yaw,\n          pitch: entity.pitch,\n          onGround: onGround\n        });\n      else if (diff.distanceTo(new Vec3(0, 0, 0)) != 0) entity._writeOthersNearby('rel_entity_move', {\n        entityId: entity.id,\n        dX: diff.x,\n        dY: diff.y,\n        dZ: diff.z,\n        onGround: onGround\n      });\n\n      entity.position = position;\n      entity.onGround = onGround;\n    }, () => {\n      if (entity.type == 'player') player.sendSelfPosition();\n    });\n  };\n\n  entity.teleport = (pos) => { // Overwritten in players inject above\n    entity.sendPosition(pos.scaled(32), false, true);\n  }\n};\n"]}