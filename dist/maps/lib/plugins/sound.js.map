{"version":3,"sources":["lib/plugins/sound.js"],"names":["Vec3","require","module","exports","server","serv","playSound","sound","world","position","whitelist","blacklist","radius","volume","pitch","players","Array","getNearby","scaled","floored","filter","indexOf","player","forEach","pos","_client","write","soundName","x","y","z","Math","round","playNoteBlock","instrument","particle","emitParticle","clone","add","count","size","getNote","pow","note","opt","on","cancel","reference","crouching","getBlockType","id","blockEntityData","toString","data","commands","base","info","usage","op","parse","str","results","match","sound_name","parseFloat","action","chat","entity","playSoundAtSelf"],"mappings":"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","file":"../../../lib/plugins/sound.js","sourcesContent":["const Vec3 = require('vec3').Vec3;\n\nmodule.exports.server=function(serv) {\n  serv.playSound = (sound, world, position, {whitelist,blacklist=[],radius=32*32,volume=1.0,pitch=1.0}={}) => {\n    const players = (typeof whitelist != 'undefined' ? (typeof whitelist instanceof Array ? whitelist : [whitelist]) : serv.getNearby({\n      world: world,\n      position: position.scaled(32).floored(),\n      radius: radius // 32 blocks, fixed position\n    }));\n    players.filter(player => blacklist.indexOf(player) == -1)\n      .forEach(player => {\n        const pos = (position || player.position.scaled(1/32)).scaled(8).floored();\n        player._client.write('named_sound_effect', {\n          soundName: sound,\n          x: pos.x,\n          y: pos.y,\n          z: pos.z,\n          volume: volume,\n          pitch: Math.round(pitch*63)\n        });\n      });\n  };\n\n  serv.playNoteBlock = (pitch, world, position, {instrument='harp', particle=true}={}) => {\n    if (particle) {\n      serv.emitParticle(23, world, position.clone().add(new Vec3(0.5, 1.5, 0.5)), {\n        count: 1,\n       size: new Vec3(0, 0, 0)\n      });\n    }\n    serv.playSound('note.' + instrument, world, position, { pitch: serv.getNote(pitch) });\n  };\n\n  serv.getNote = note => 0.5 * Math.pow(Math.pow(2, 1/12), note);\n};\n\nmodule.exports.player=function(player,serv) {\n  player.playSound = (sound, opt={}) => {\n    opt.whitelist = player;\n    serv.playSound(sound, player.world, null, opt);\n  };\n\n  player.on('placeBlock_cancel', async ({reference}, cancel) => {\n    if (player.crouching) return;\n    const id = await player.world.getBlockType(reference);\n    if (id != 25) return;\n    cancel(false);\n    if (!player.world.blockEntityData[reference.toString()]) player.world.blockEntityData[reference.toString()] = {};\n    const data = player.world.blockEntityData[reference.toString()];\n    if (typeof data.note == 'undefined') data.note = -1;\n    data.note++;\n    data.note %= 25;\n    serv.playNoteBlock(data.note, player.world, reference);\n  });\n\n  player.on('dig_cancel', async ({position}, cancel) => {\n    const id = await player.world.getBlockType(position);\n    if (id != 25) return;\n    cancel(false);\n    if (!player.world.blockEntityData[position.toString()]) player.world.blockEntityData[position.toString()] = {};\n    const data = player.world.blockEntityData[position.toString()];\n    if (typeof data.note == 'undefined') data.note = 0;\n    serv.playNoteBlock(data.note ,player.world, position);\n  });\n\n\n  player.commands.add({\n    base: 'playsound',\n    info: 'to play sound for yourself',\n    usage: '/playsound <sound_name> [volume] [pitch]',\n    op: true,\n    parse(str) {\n      const results=str.match(/([^ ]+)(?: ([^ ]+))?(?: ([^ ]+))?/);\n      if(!results) return false;\n      return {\n        sound_name:results[1],\n        volume:results[2] ? parseFloat(results[2]) : 1.0,\n        pitch:results[3] ? parseFloat(results[3]) : 1.0\n      };\n    },\n    action({sound_name,volume,pitch}) {\n      player.chat('Playing \"'+sound_name+'\" (volume: ' + volume + ', pitch: ' + pitch + ')');\n      player.playSound(sound_name, {volume: volume,pitch: pitch});\n    }\n  });\n\n  player.commands.add({\n    base: 'playsoundforall',\n    info: 'to play sound for everyone',\n    usage: '/playsoundforall <sound_name> [volume] [pitch]',\n    op: true,\n    parse(str) {\n      const results=str.match(/([^ ]+)(?: ([^ ]+))?(?: ([^ ]+))?/);\n      if(!results) return false;\n      return {\n        sound_name:results[1],\n        volume:results[2] ? parseFloat(results[2]) : 1.0,\n        pitch:results[3] ? parseFloat(results[3]) : 1.0\n      };\n    },\n    action({sound_name,volume,pitch}) {\n      player.chat('Playing \"'+sound_name+'\" (volume: ' + volume + ', pitch: ' + pitch + ')');\n      serv.playSound(sound_name, player.world, player.position.scaled(1/32), {volume: volume,pitch: pitch});\n    }\n  });\n};\n\nmodule.exports.entity=function(entity,serv) {\n  entity.playSoundAtSelf = (sound, opt={}) => {\n    serv.playSound(sound, entity.world, entity.position.scaled(1/32), opt);\n  }\n};"]}