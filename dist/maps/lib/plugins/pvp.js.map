{"version":3,"sources":["lib/plugins/pvp.js"],"names":["Vec3","require","UserError","module","exports","player","serv","updateHealth","health","_client","write","food","foodSaturation","attackEntity","entityId","attackedEntity","entities","gameMode","type","behavior","velocity","position","minus","plus","scaled","o","takeDamage","on","mouse","target","dragon","entityType","commands","add","base","info","usage","op","parse","str","action","sel","arr","selectorString","length","map","entity","damage","sound","maxVelocity","animation","playSound","world","sendVelocity","_writeOthers","id","entityStatus"],"mappings":"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","file":"../../../lib/plugins/pvp.js","sourcesContent":["const Vec3 = require(\"vec3\").Vec3;\nconst UserError = require('flying-squid').UserError;\n\nmodule.exports.player=function(player,serv)\n{\n\n  player.updateHealth = (health) => {\n    player.health = health;\n    player._client.write('update_health', {\n      food: player.food,\n      foodSaturation: 0.0,\n      health: player.health\n    });\n  };\n\n  function attackEntity(entityId) \n  {\n    const attackedEntity = serv.entities[entityId];\n    if(!attackedEntity || (attackedEntity.gameMode != 0 && attackedEntity.type == 'player')) return;\n\n    player.behavior('attack', {\n      attackedEntity: attackedEntity,\n      velocity: attackedEntity.position.minus(player.position).plus(new Vec3(0, 0.5, 0)).scaled(5)\n    }, (o) => o.attackedEntity.takeDamage(o));\n  }\n\n  player._client.on(\"use_entity\", ({mouse,target} = {}) => {\n    if(!serv.entities[target])\n    {\n      let dragon;\n      for(dragon=target-1;dragon>=target-7 && !serv.entities[dragon];dragon--){}\n      if(serv.entities[dragon] && serv.entities[dragon].entityType==63)\n         target=dragon;\n    }\n    if(mouse == 1)\n      attackEntity(target);\n  });\n\n  player.commands.add({\n    base: 'kill',\n    info: 'Kill entities',\n    usage: '/kill <selector>',\n    op: true,\n    parse(str) {\n      return str || false;\n    },\n    action(sel) {\n      let arr = player.selectorString(sel);\n      if (arr.length==0) throw new UserError('Could not find player');\n\n      arr.map(entity => entity.takeDamage({damage:20}));\n    }\n  });\n\n};\n\nmodule.exports.entity=function(entity,serv)\n{\n  entity.takeDamage=({sound='game.player.hurt', damage=1, velocity=new Vec3(0,0,0), maxVelocity=new Vec3(4, 4, 4), animation=true}) => {\n    entity.updateHealth(entity.health - damage);\n    serv.playSound(sound, entity.world, entity.position.scaled(1/32));\n\n    entity.sendVelocity(velocity.scaled(1/32), maxVelocity);\n\n    if(entity.health<=0) {\n      if(animation)\n        entity._writeOthers('entity_status', {\n          entityId: entity.id,\n          entityStatus: 3\n        });\n      if(entity.type!=\"player\")\n        delete serv.entities[entity.id];\n    }\n    else if (animation)\n      entity._writeOthers('animation',{\n        entityId:entity.id,\n        animation:1\n      });\n  };\n\n  if (entity.type != 'player') {\n    entity.updateHealth = (health) => {\n      entity.health = health;\n    }\n  }\n};"]}