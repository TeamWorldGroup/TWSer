{"version":3,"sources":["lib/plugins/effects.js"],"names":["module","exports","entity","serv","effects","i","sendEffect","effectId","amplifier","duration","particles","whitelist","blacklist","getNearby","type","indexOf","sendAbilities","sendTo","filter","p","data","entityId","id","hideParticles","_writeArray","sendRemoveEffect","addEffect","opt","amp","override","end","Date","now","timeout","setTimeout","removeEffect","clearTimeout","player","commands","add","base","info","usage","parse","str","match","action","params","targets","selectorString","forEach","e","effId","parseInt","chatSelect","length","username","chat"],"mappings":"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","file":"../../../lib/plugins/effects.js","sourcesContent":["\nmodule.exports.entity = function(entity, serv) {\n  entity.effects = {};\n  for (let i = 1; i <= 23; i++) { // 23 in 1.8, 27 in 1.9\n    entity.effects[i] = null; // Just so we know it's a real potion and not undefined/not existant\n  }\n\n  entity.sendEffect = (effectId, {amplifier=0,duration=30*20,particles=true,whitelist,blacklist=[]}={}) => {\n    if (!whitelist) whitelist = serv.getNearby(entity);\n    if (entity.type == 'player' && [1].indexOf(effectId) != -1) entity.sendAbilities();\n    const sendTo = whitelist.filter(p => blacklist.indexOf(p) == -1);\n    const data = {\n      entityId: entity.id,\n      effectId: effectId,\n      amplifier: amplifier,\n      duration: duration,\n      hideParticles: !particles\n    };\n    serv._writeArray('entity_effect', data, sendTo);\n  };\n\n  entity.sendRemoveEffect = (effectId, {whitelist,blacklist=[]}={}) => {\n    if (!whitelist) whitelist = serv.getNearby(entity);\n    const sendTo = whitelist.filter(p => blacklist.indexOf(p) == -1);\n    serv._writeArray('remove_entity_effect', {\n      entityId: entity.id,\n      effectId: effectId\n    }, sendTo);\n  };\n\n  entity.addEffect = (effectId, opt={}) => {\n    const amp = typeof opt.amplifier == 'undefined' ? 0 : opt.amplifier;\n    if (!entity.effects[effectId] || opt.override || amp < entity.effects[effectId].amplifier) {\n      entity.effects[effectId] = {\n        amplifier: opt.amplifier || 0,\n        duration: opt.duration || 30*20,\n        particles: opt.particles || true,\n        end: Date.now() + (opt.duration || 30*20)*1000/20, // 1000/20 == convert from ticks to milliseconds,\n        timeout:setTimeout(() => entity.removeEffect(effectId),(opt.duration || 30*20)*1000/20)\n      };\n      entity.sendEffect(effectId, opt);\n      return true;\n    } else return false;\n  };\n\n  entity.removeEffect = (effectId, opt) => {\n    clearTimeout(entity.effects[effectId].timeout);\n    entity.effects[effectId] = null;\n    entity.sendRemoveEffect(effectId, opt);\n  };\n};\n\nmodule.exports.player = function(player) {\n  player.commands.add({\n    base: 'effect',\n    info: 'Give player an effect',\n    usage: '/effect <player> <effect> [seconds] [amplifier] [hideParticles]',\n    parse(str) {\n      return str.match(/(.+?) (\\d+)(?: (\\d+))?(?: (\\d+))?(?: (true|false))?|.*? clear/) || false;\n    },\n    action(params) {\n      const targets = player.selectorString(params[1]);\n      if (params[2] == 'clear') {\n        targets.forEach(e => Object.keys(e.effects).forEach(effectId => {\n          if (e.effects[effectId] != null) e.removeEffect(effectId);\n        }));\n      } else {\n        targets.forEach(e => {\n          const effId = parseInt(params[2]);\n          if (e.effects[effId]) {\n            e.removeEffect(effId);\n          }\n          e.addEffect(effId, {\n            amplifier: parseInt(params[4]) || 0,\n            duration: parseInt(params[3]) * 20 || 30 * 20,\n            particles: params[5] != 'true' // hidesParticles vs particles (i.e. \"showParticles\")\n          });\n        });\n      }\n      const chatSelect = (targets.length == 1 ? (targets[0].type == 'player' ? targets[0].username : 'entity') : 'entities');\n      if (params[2] == 'clear') player.chat('Remove all effects from ' + chatSelect + '.' );\n      else player.chat('Gave ' + chatSelect + ' effect ' + params[2] + '(' + (params[4] || 0) + ') for ' + \n                        (parseInt(params[3]) || 30) + ' seconds');\n    }\n  });\n};"]}